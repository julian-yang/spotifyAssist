<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/auth/authentication.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/auth</a> authentication.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">21.59% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>19/88</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">10% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>3/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">22.89% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>19/83</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import {NextFunction, Request, Response, Router} from 'express';
import {OAuth2Client} from 'google-auth-libr<span class="fstat-no" title="function not covered" >ar</span>y';
impo<span class="cstat-no" title="statement not covered" >rt * as jwt from 'jsonwebtoken';<span class="fstat-no" title="function not covered" ></span></span>
import {URL} from<span class="fstat-no" title="function not covered" > 'url';<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ></span></span></span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span></span>
import {GOOGLE_CA<span class="fstat-no" title="function not covered" >LLBAC</span>K_URL, IS_<span class="cstat-no" title="statement not covered" >DEV, TOKEN_TYPE} from '../config/constants';<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span>
import *<span class="cstat-no" title="statement not covered" > as db from '../models/db';</span>
&nbsp;
import * as spotify from './spotify';
import * as token from './token';
&nbsp;
const googleOauth2 = new OAuth2Client(
    process.env.GOOGLE_CLIENT_ID,
    process.env.GOOGLE_CLIENT_SECRET,
    // Don't need this right now I think.
    GOOGLE_CALLBACK_URL,
);
&nbsp;
// Doesn't work right now.
const redirectToGoogleSignin = (req: Request, res: Response) =&gt; {
  const assistantRedirectUrl = req.query.redirect_uri;
  const stateToken =
      jwt.sign(assistantRedirec<span class="fstat-no" title="function not covered" >tU</span>rl, process.env.JWT_TOKEN_SECRET);
  const authUrl = googleOauth2.ge<span class="cstat-no" title="statement not covered" >nerateAuthUrl({</span>
    access_type: 'offli<span class="cstat-no" title="statement not covered" >ne',</span>
    client_id: proce<span class="cstat-no" title="statement not covered" >ss.env.GOOGLE_CLIENT_ID,</span>
    include_granted_scopes: true,
    prompt: 'select_account',
    redirect_uri: GOOGLE_CALLBACK_URL,
    scope: ['profile'],
    state: stateToken
  });
  res.redirect(authUrl);
};
<span class="cstat-no" title="statement not covered" ></span>
// for testing
function testSignin(req: Request, res: Response): void {
  const h<span class="fstat-no" title="function not covered" >ostName = r</span>eq.hostname;
  const protocol = re<span class="cstat-no" title="statement not covered" >q.protocol;</span>
  const port = IS_DEV<span class="cstat-no" title="statement not covered" > ? ':5000' : </span>'';
  const redirectU<span class="cstat-no" title="statement not covered" >rl = `${protocol}://${hostName}${p</span>ort}/auth/signinResult`;
  const hrefUrl = `signi<span class="cstat-no" title="statement not covered" >n?client_id=google&amp;redirect_uri=${redirectUrl}`;</span>
  res.render('signin<span class="cstat-no" title="statement not covered" >', {redirectUrl});</span>
}<span class="cstat-no" title="statement not covered" ></span>
&nbsp;
async fun<span class="fstat-no" title="function not covered" >ction signi</span>nPost(req: Request, res: Response) {
  co<span class="cstat-no" title="statement not covered" >nst idtoken = req.body.idtoken;<span class="fstat-no" title="function not covered" ></span></span>
  const state = req.body<span class="cstat-no" title="statement not covered" >.state;</span>
  const redirectUrl = <span class="cstat-no" title="statement not covered" >req.body.redire</span>ctUrl;
  const clientId = req.body.<span class="cstat-no" title="statement not covered" >clientId;</span>
  // Verify the id_token,<span class="cstat-no" title="statement not covered" > and access the cl</span>aims.
  try {
    cons<span class="cstat-no" title="statement not covered" >t ticket = await googleOauth2.verifyIdToken({</span>
      idToken: idtoken,<span class="cstat-no" title="statement not covered" ></span>
      audience: process.env.GOOGLE_CLIENT_ID,
    });
&nbsp;
    const googleId = ticket.g<span class="cstat-no" title="statement not covered" >etUserId();</span>
    console.<span class="cstat-no" title="statement not covered" >log('googleId: ' + googleId);</span>
    // fetch/create user.
    const user =<span class="cstat-no" title="statement not covered" ></span>
        (await db.models.User.fin<span class="cstat-no" title="statement not covered" >dOrCreate({where: {google_id: googleId}}))[0];</span>
    const authFlowInfo: AuthFlowInfo =
        {userId: user.id, clientId: 'google', state, redirectUrl};
<span class="cstat-no" title="statement not covered" ></span>
    // if user d<span class="cstat-no" title="statement not covered" >oes not have spot</span>ify credentials, redirect to spotify auth.
    // else retu<span class="cstat-no" title="statement not covered" >rn auth codes</span>
    if (!user.spotify_access_token) {
      req.user = user;
      spotify.loginSpotify(authFlowInfo, res);
    } else {
      // get ten<span class="cstat-no" title="statement not covered" > minutes from now.</span>
      // create new authorization
      returnAuthCode(authFlowInfo, res);
    }
  } catch (e<span class="cstat-no" title="statement not covered" >rr) {</span>
    console.log('Something went wrong!: ' + err);
  }
}
<span class="fstat-no" title="function not covered" ></span>
function signinRe<span class="cstat-no" title="statement not covered" >sult(req: Reque</span>st, res: Response) {
  const code = req<span class="cstat-no" title="statement not covered" >.query.code;</span>
  co<span class="cstat-no" title="statement not covered" >nst state = req.query.state;</span>
  res.render('signin_result', {authCodeToken: code, state});
}<span class="fstat-no" title="function not covered" ></span>
<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span>
export interface AuthFlowInfo {
  userId: number;<span class="cstat-no" title="statement not covered" ></span>
  clientId: string;<span class="cstat-no" title="statement not covered" ></span>
  state:<span class="cstat-no" title="statement not covered" > string;</span>
  redire<span class="cstat-no" title="statement not covered" >ctUrl: string;</span>
}<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" ></span>
export i<span class="cstat-no" title="statement not covered" >nterface AuthFlowInfoWra</span>pper { authFlowInfo: AuthFlowInfo; }
&nbsp;
export async function returnAuthCode(
    authCodeInfo: AuthFlowInfo, res: Response) {
  // buil<span class="fstat-no" title="function not covered" >d redirect url</span>
  const authCode = to<span class="cstat-no" title="statement not covered" >ken.generateTokenCo</span>de(
      authCodeInfo.userId<span class="cstat-no" title="statement not covered" >, authCodeInfo.clientId</span>, TOKEN_TYPE.AUTH_CODE);
  const completeRedire<span class="cstat-no" title="statement not covered" >ctUrl = new URL(auth</span>CodeInfo.redirectUrl);
  completeRedirectUrl.searchParams.append('code', authCode);
  completeRedirectUrl.s<span class="cstat-no" title="statement not covered" >earchParams.append('state', authCodeInfo.state);</span>
  co<span class="cstat-no" title="statement not covered" >nst redirect = completeRedirectUrl.hr</span>ef;
  console.log(redirect);<span class="cstat-no" title="statement not covered" ></span>
  res.redirect(redi<span class="cstat-no" title="statement not covered" >rect);</span>
}<span class="cstat-no" title="statement not covered" ></span>
&nbsp;
function exchangeToken(re<span class="cstat-no" title="statement not covered" >q: Request, res: Response) {</span>
  const <span class="cstat-no" title="statement not covered" >clientId = req.body.</span>client_id;
  const clientSecret = req.body.client_secret;
  const g<span class="cstat-no" title="statement not covered" >rantType = req.body.grant_type;</span>
  // TODO: validate clientId &amp;&amp; clientSecret pairing.
  const inputToken = req.<span class="cstat-no" title="statement not covered" >body.code ? req.body.code : req.body.refresh_token;</span>
  consol<span class="cstat-no" title="statement not covered" >e.log(`token: ${inpu</span>tToken}`);
  const verifiedToken = token.decryptTokenCode(inputToken);
&nbsp;
  const <span class="cstat-no" title="statement not covered" >userId = verifiedToken.userId;</span>
  if (grantType === 'authorization_code' &amp;&amp;
      isValidToken(verifiedToken, clientId, TOKEN_TYPE.AUTH_CODE)) {
    const<span class="fstat-no" title="function not covered" > response = b</span>uildTokenExchangeResponse(
        userId, clientId, <span class="cstat-no" title="statement not covered" >true /*includeRefreshToken*/</span>);
    res.json(response);<span class="cstat-no" title="statement not covered" ></span>
  } else if (<span class="cstat-no" title="statement not covered" ></span>
      grantType === 'refresh_token' &amp;&amp;
      isValidToken(verifiedToken, clientId, TOKEN_TYPE.REFRESH_TOKEN)) {
<span class="cstat-no" title="statement not covered" >    const response = buildTokenExchangeResponse(</span>
        userId, clientId, false /*includeRefreshToken*/);
    res.j<span class="fstat-no" title="function not covered" >son(response);</span>
  } else {<span class="cstat-no" title="statement not covered" ></span>
    res.status(400).json({error: 'invalid_grant'});
  }
}
&nbsp;
func<span class="cstat-no" title="statement not covered" >tion isValidToken(</span>
    toke<span class="cstat-no" title="statement not covered" >n: token.Token, clientId: string, expectedTokenType: TOKEN_TYPE) {</span>
  const validClientId = token.clientId === clientId;
  const validTokenType = token.type === expectedTokenType;
  co<span class="cstat-no" title="statement not covered" >nst notExpired = </span>expectedTokenType === TOKEN_TYPE.AUTH_CODE ?
      token.expiresAt.getDate() &gt; Date.now() :
      true;
  return validClientId &amp;&amp; validTokenType &amp;&amp; notExpired;
}
&nbsp;
interface TokenExchangeResponse {
  token_type: string;
  access_token: string;
  expires_in: number;
  refresh_token?: string;
}
&nbsp;
function buildTokenExchangeResponse(
    userId: number, clientId: string, includeRefreshToken: boolean) {
  const response: TokenExchangeResponse = {
    token_type: 'bearer',
    access_token:
        token.generateTokenCode(userId, clientId, TOKEN_TYPE.ACCESS_TOKEN),
    expires_in: 60 * 60
  };
  if (includeRefreshToken) {
    response.refresh_token =
        token.generateTokenCode(userId, clientId, TOKEN_TYPE.REFRESH_TOKEN);
  }
  return response;
}
&nbsp;
export const router = Router();
router.get('/signin', testSignin);
router.post('/signin', signinPost);
router.get('/signinResult', signinResult);
router.post('/exchangeToken', exchangeToken);
router.get('/spotifyCallback', spotify.processSpotifyLogin);
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Sun Jan 21 2018 00:49:44 GMT-0800 (PST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
